<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hello Cube with Roboflow</title>
    <!-- Load three.js first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load ARToolkit scripts -->
    <script src="jsartoolkit5/artoolkit.min.js"></script>
    <script src="jsartoolkit5/artoolkit.api.js"></script>
    <!-- Load AR.js/threex scripts in the correct order -->
    <script src="threex/threex-artoolkitsource.js"></script>
    <script src="threex/threex-artoolkitcontext.js"></script>
    <script src="threex/threex-armarkercontrols.js"></script>
    <script src="threex/threex-arsmoothedcontrols.js"></script>
</head>
<body style="margin: 0; overflow: hidden; font-family: Monospace">
    <script>
        var scene, camera, renderer, clock, deltaTime, totalTime;
        var arToolkitSource, arToolkitContext;
        var markerRoot1, markerRoot2;
		var mesh1;

        // Add Roboflow credentials
        var roboflowModel = 'anchored-reality/1';
        var roboflowApiKey = 'rf_cmx7eGjwNDbEUF9B8UITkBIGORH2';

        init();
        animte();

        function init() {
            // Initialize scene and camera
            scene = new THREE.Scene();

			let ambientLight = new THREE.AmbientLight( 0xcccccc, 0.5 );
			scene.add( ambientLight );

            camera = new THREE.Camera();
            scene.add(camera);

            // Initialize renderer
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(640,480);
            renderer.setClearColor(new THREE.Color('lightgrey'), 0);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0px';
            renderer.domElement.style.left = '0px';
            document.body.appendChild(renderer.domElement);

			clock = new THREE.Clock()
			deltaTime = 0;
			totalTime = 0;

            // Initialize ARToolkitSource with Roboflow integration
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
            });

            arToolkitSource.init(function onReady() {
                onResize();
            });

            // Handle window resize
            window.addEventListener('resize', function () {
                onResize();
            });

            // Initialize ARToolkitContext with Roboflow
            arToolkitContext = new THREEx.ArToolkitContext({
                trackingBackend: 'roboflow',
                cameraParametersUrl: 'data/camera_para.dat',
                detectionMode: 'mono',
                roboflowModel: roboflowModel,
                roboflowApiKey: roboflowApiKey,
            });

            arToolkitContext.init(function onCompleted() {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });

            // Create marker root
            markerRoot1 = new THREE.Group();
            scene.add(markerRoot1);

            // Set up marker controls with Roboflow type
            let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
                type: 'roboflow',
            });

            // Add a cube to the marker root
            var geometry = new THREE.BoxGeometry(1, 1, 1);
            var material = new THREE.MeshNormalMaterial({ transparent: true, opacity: 0.5, side: THREE.DoubleSide });
            var cube = new THREE.Mesh(geometry, material);
            cube.position.y = 0.5;
            markerRoot1.add(cube);
        }

		function onResize()
		{
			arToolkitSource.onResize()	
			arToolkitSource.copySizeTo(renderer.domElement)	
			if ( arToolkitContext.arController !== null )
			{
				arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)	
			}	
		}

        function render() {
            requestAnimationFrame(render);

            if (arToolkitSource.ready !== false) {
                arToolkitContext.update(arToolkitSource.domElement);
            }

            renderer.render(scene, camera);
        }

		function animate()
		{
			requestAnimationFrame(animate);
			deltaTime = clock.getDelta();
			totalTime += deltaTime;
			update();
			render();
		}
    </script>
</body>
</html>