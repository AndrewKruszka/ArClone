<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hello Cube with Roboflow</title>
    <!-- Load three.js first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Load ARToolkit scripts -->
    <script src="jsartoolkit5/artoolkit.min.js"></script>
    <script src="jsartoolkit5/artoolkit.api.js"></script>
    <!-- Load AR.js/threex scripts in the correct order -->
    <script src="threex/threex-artoolkitsource.js"></script>
    <script src="threex/threex-artoolkitcontext.js"></script>
    <script src="threex/threex-armarkercontrols.js"></script>
    <script src="threex/threex-arsmoothedcontrols.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <script>
        var scene, camera, renderer;
        var arToolkitSource, arToolkitContext;
        var markerRoot1;

        // Add Roboflow credentials
        var roboflowModel = 'anchored-reality/1';
        var roboflowApiKey = 'rf_cmx7eGjwNDbEUF9B8UITkBIGORH2';

        init();
        render();

        function init() {
            // Initialize scene and camera
            scene = new THREE.Scene();
            camera = new THREE.Camera();
            scene.add(camera);

            // Initialize renderer
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(new THREE.Color('lightgrey'), 0);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Initialize ARToolkitSource with Roboflow integration
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'roboflow',
                roboflowModel: roboflowModel,
                roboflowApiKey: roboflowApiKey,
            });

            arToolkitSource.init(function onReady() {
                onResize();
            });

            // Handle window resize
            window.addEventListener('resize', function () {
                onResize();
            });

            // Initialize ARToolkitContext with Roboflow
            arToolkitContext = new THREEx.ArToolkitContext({
                trackingBackend: 'roboflow',
                cameraParametersUrl: 'data/camera_para.dat',
                detectionMode: 'mono',
                roboflowModel: roboflowModel,
                roboflowApiKey: roboflowApiKey,
            });

            arToolkitContext.init(function onCompleted() {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });

            // Create marker root
            markerRoot1 = new THREE.Group();
            scene.add(markerRoot1);

            // Set up marker controls with Roboflow type
            let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
                type: 'roboflow',
            });

            // Add a cube to the marker root
            var geometry = new THREE.BoxGeometry(1, 1, 1);
            var material = new THREE.MeshNormalMaterial({ transparent: true, opacity: 0.5, side: THREE.DoubleSide });
            var cube = new THREE.Mesh(geometry, material);
            cube.position.y = 0.5;
            markerRoot1.add(cube);
        }

        function onResize() {
            arToolkitSource.onResizeElement();
            arToolkitSource.copyElementSizeTo(renderer.domElement);
            if (arToolkitContext.arController !== null) {
                arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
            }
        }

        function render() {
            requestAnimationFrame(render);

            if (arToolkitSource.ready !== false) {
                arToolkitContext.update(arToolkitSource.domElement);
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>